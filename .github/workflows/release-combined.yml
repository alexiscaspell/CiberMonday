name: Release Combined (Android + Windows)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Versi√≥n del release (ej: 1.0.0)'
        required: true
        default: '1.0.0'
      prerelease:
        description: '¬øEs una versi√≥n pre-release?'
        required: false
        default: false
        type: boolean

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Grant execute permission for scripts
        run: |
          chmod +x build_android.sh

      - name: Build Android APK
        run: ./build_android.sh

      - name: Verify APK exists
        run: |
          if [ ! -f "dist/CiberMondayServer.apk" ]; then
            echo "Error: APK no encontrado"
            exit 1
          fi
          ls -lh dist/CiberMondayServer.apk

      - name: Create APK filename
        run: echo "APK_FILENAME=CiberMondayServer-v${{ github.event.inputs.version }}.apk" >> $GITHUB_ENV

      - name: Rename APK
        run: |
          cp dist/CiberMondayServer.apk ${{ env.APK_FILENAME }}
          ls -lh ${{ env.APK_FILENAME }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ env.APK_FILENAME }}
          retention-days: 7

  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install Flask flask-cors requests pywin32 pyinstaller
      
      - name: Compilar cliente
        working-directory: ./client
        run: |
          pyinstaller --onefile `
            --name "CiberMondayClient" `
            --hidden-import "winreg" `
            --hidden-import "win32serviceutil" `
            --hidden-import "win32service" `
            --hidden-import "win32event" `
            --hidden-import "servicemanager" `
            --hidden-import "win32timezone" `
            --hidden-import "protection" `
            --hidden-import "registry_manager" `
            --hidden-import "config_gui" `
            --hidden-import "tkinter" `
            --hidden-import "tkinter.ttk" `
            --hidden-import "tkinter.messagebox" `
            --hidden-import "requests" `
            --hidden-import "ctypes" `
            --hidden-import "ctypes.wintypes" `
            client.py
      
      - name: Compilar servicio
        working-directory: ./client
        run: |
          pyinstaller --onefile `
            --name "CiberMondayService" `
            --hidden-import "winreg" `
            --hidden-import "win32serviceutil" `
            --hidden-import "win32service" `
            --hidden-import "win32event" `
            --hidden-import "servicemanager" `
            --hidden-import "win32timezone" `
            --hidden-import "protection" `
            --hidden-import "firewall_manager" `
            --hidden-import "ctypes" `
            --hidden-import "ctypes.wintypes" `
            service.py
      
      - name: Compilar watchdog
        working-directory: ./client
        run: |
          pyinstaller --onefile `
            --name "CiberMondayWatchdog" `
            --hidden-import "winreg" `
            --hidden-import "subprocess" `
            --hidden-import "protection" `
            --hidden-import "ctypes" `
            --hidden-import "ctypes.wintypes" `
            watchdog.py
      
      - name: Verificar ejecutables generados
        working-directory: ./client/dist
        shell: cmd
        run: |
          dir *.exe
          if not exist CiberMondayClient.exe exit /b 1
          if not exist CiberMondayService.exe exit /b 1
          if not exist CiberMondayWatchdog.exe exit /b 1
      
      - name: Crear directorio temporal para release
        shell: cmd
        run: |
          mkdir release-windows
      
      - name: Copiar archivos a directorio plano
        shell: cmd
        run: |
          copy client\dist\CiberMondayClient.exe release-windows\
          copy client\dist\CiberMondayService.exe release-windows\
          copy client\dist\CiberMondayWatchdog.exe release-windows\
          copy client\install_exe_service.bat release-windows\
          copy client\uninstall_exe_service.bat release-windows\
          dir release-windows\
      
      - name: Verificar archivos copiados
        shell: cmd
        run: |
          if not exist release-windows\CiberMondayClient.exe exit /b 1
          if not exist release-windows\CiberMondayService.exe exit /b 1
          if not exist release-windows\CiberMondayWatchdog.exe exit /b 1
          if not exist release-windows\install_exe_service.bat exit /b 1
          if not exist release-windows\uninstall_exe_service.bat exit /b 1
          echo "Todos los archivos verificados correctamente"
      
      - name: Upload Windows executables artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: release-windows/*
          if-no-files-found: error
          retention-days: 7

  create-release:
    runs-on: ubuntu-latest
    needs: [build-android, build-windows]
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./release-files

      - name: Download Windows executables
        uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: ./release-files

      - name: List release files
        run: |
          echo "Archivos para la release:"
          ls -lh release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: CiberMonday v${{ github.event.inputs.version }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            release-files/*.apk
            release-files/*.exe
            release-files/*.bat
          body: |
            # CiberMonday v${{ github.event.inputs.version }}
            
            Release completa de CiberMonday incluyendo servidor Android y cliente Windows.
            
            ## üì¶ Contenido del Release
            
            ### üì± Servidor Android
            - **CiberMondayServer-v${{ github.event.inputs.version }}.apk** - Servidor para Android
            
            ### üñ•Ô∏è Cliente Windows
            - **CiberMondayClient.exe** - Cliente principal
            - **CiberMondayService.exe** - Servicio de Windows
            - **CiberMondayWatchdog.exe** - Watchdog independiente
            - **install_exe_service.bat** - Instalador del servicio
            - **uninstall_exe_service.bat** - Desinstalador del servicio
            
            ---
            
            ## üì± Instalaci√≥n del Servidor Android
            
            1. Descarga el archivo `CiberMondayServer-v${{ github.event.inputs.version }}.apk`
            2. Transfiere el APK a tu dispositivo Android
            3. Habilita "Instalar desde fuentes desconocidas" en la configuraci√≥n de seguridad
            4. Abre el archivo APK e inst√°lalo
            
            ### Caracter√≠sticas del Servidor Android
            - Servidor HTTP integrado para gestionar clientes
            - Interfaz nativa de Android
            - Gesti√≥n de sesiones de tiempo
            - Configuraci√≥n de clientes (intervalo de sincronizaci√≥n, alertas)
            - Edici√≥n de nombres de clientes
            - Accesible desde otros dispositivos en la misma red WiFi
            
            ### Requisitos del Servidor
            - Android 7.0 (API 24) o superior
            - Conexi√≥n WiFi para acceso desde otros dispositivos
            - Permisos de red habilitados
            
            ---
            
            ## üñ•Ô∏è Instalaci√≥n del Cliente Windows
            
            1. Descarga **todos los archivos** del cliente Windows
            2. Extrae los archivos en una carpeta (ej: `C:\CiberMonday\`)
            3. Ejecuta `install_exe_service.bat` como Administrador
            4. Si es la primera vez, se abrir√° la ventana de configuraci√≥n del servidor
            5. El servicio se instalar√°, configurar√° e iniciar√° autom√°ticamente
            
            **Estructura de archivos despu√©s de extraer:**
            ```
            C:\CiberMonday\
            ‚îú‚îÄ‚îÄ CiberMondayClient.exe
            ‚îú‚îÄ‚îÄ CiberMondayService.exe
            ‚îú‚îÄ‚îÄ CiberMondayWatchdog.exe
            ‚îú‚îÄ‚îÄ install_exe_service.bat
            ‚îî‚îÄ‚îÄ uninstall_exe_service.bat
            ```
            
            ### Protecciones del servicio
            - Inicio autom√°tico con Windows
            - Recuperaci√≥n autom√°tica si el servicio falla (reinicio en 5s)
            - Watchdog interno reinicia el cliente si muere (cada 3s)
            - Protecci√≥n DACL contra terminaci√≥n del proceso
            - Solo administradores pueden detener el servicio
            
            ### Requisitos del Cliente
            - Windows 10 o superior
            - Permisos de Administrador
            - Conexi√≥n de red al servidor
            
            ### Gesti√≥n del servicio (requiere Administrador)
            ```bash
            net start CiberMondayClient    # Iniciar
            net stop CiberMondayClient     # Detener
            ```
            
            ### Desinstalaci√≥n
            Ejecuta `uninstall_exe_service.bat` como Administrador para remover completamente el servicio.
            
            ---
            
            ## üîó Conexi√≥n Cliente-Servidor
            
            ### Configuraci√≥n del Servidor Android
            1. Abre la aplicaci√≥n en el dispositivo Android
            2. El servidor se iniciar√° autom√°ticamente en el puerto 5000
            3. La IP del servidor se mostrar√° en la pantalla principal (ej: `192.168.1.100`)
            
            ### Configuraci√≥n del Cliente Windows
            1. Al ejecutar el cliente por primera vez, se abrir√° una ventana de configuraci√≥n
            2. Ingresa la URL del servidor: `http://[IP_DEL_SERVIDOR]:5000`
            3. Ejemplo: `http://192.168.1.100:5000`
            4. La configuraci√≥n se guardar√° autom√°ticamente
            
            **Nota**: Aseg√∫rate de que el dispositivo Android y la PC Windows est√©n en la misma red WiFi.
            
            ---
            
            ## üìù Notas
            
            - El servidor Android escucha en la IP WiFi del dispositivo
            - El cliente Windows funciona sin conexi√≥n continua gracias al registro local
            - Sincroniza con el servidor cada 30 segundos (configurable)
            - Bloquea autom√°ticamente la PC cuando expira el tiempo asignado
            
            ---
            
            **Compilado el:** ${{ github.event.head_commit.timestamp || github.run_started_at }}  
            **Commit:** ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
