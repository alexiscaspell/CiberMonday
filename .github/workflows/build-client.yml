name: Build Windows Client

on:
  workflow_dispatch:  # Solo ejecuci贸n manual
    inputs:
      version:
        description: 'Versi贸n del release (ej: 1.0.0)'
        required: true
        default: '1.0.0'
      prerelease:
        description: '驴Es una versi贸n pre-release?'
        required: false
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Necesario para crear releases
      pull-requests: read  # Solo lectura para PRs
    
    steps:
    - name: Checkout c贸digo
      uses: actions/checkout@v3
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install Flask flask-cors requests pywin32 pyinstaller
    
    - name: Compilar cliente
      working-directory: ./client
      run: |
        pyinstaller --onefile `
          --name "CiberMondayClient" `
          --hidden-import "winreg" `
          --hidden-import "win32serviceutil" `
          --hidden-import "win32service" `
          --hidden-import "win32event" `
          --hidden-import "servicemanager" `
          --hidden-import "protection" `
          --hidden-import "registry_manager" `
          --hidden-import "config_gui" `
          --hidden-import "tkinter" `
          --hidden-import "tkinter.ttk" `
          --hidden-import "tkinter.messagebox" `
          --hidden-import "requests" `
          --hidden-import "ctypes" `
          --hidden-import "ctypes.wintypes" `
          client.py
    
    - name: Compilar servicio
      working-directory: ./client
      run: |
        pyinstaller --onefile `
          --name "CiberMondayService" `
          --hidden-import "winreg" `
          --hidden-import "win32serviceutil" `
          --hidden-import "win32service" `
          --hidden-import "win32event" `
          --hidden-import "servicemanager" `
          --hidden-import "protection" `
          --hidden-import "registry_manager" `
          --hidden-import "config_gui" `
          --hidden-import "tkinter" `
          --hidden-import "tkinter.ttk" `
          --hidden-import "tkinter.messagebox" `
          --hidden-import "requests" `
          --hidden-import "ctypes" `
          --hidden-import "ctypes.wintypes" `
          service.py
    
    - name: Compilar watchdog
      working-directory: ./client
      run: |
        pyinstaller --onefile `
          --name "CiberMondayWatchdog" `
          --hidden-import "winreg" `
          --hidden-import "subprocess" `
          watchdog.py
    
    - name: Verificar ejecutables generados
      working-directory: ./client/dist
      shell: cmd
      run: |
        dir *.exe
        if not exist CiberMondayClient.exe exit /b 1
        if not exist CiberMondayService.exe exit /b 1
        if not exist CiberMondayWatchdog.exe exit /b 1
    
    - name: Crear release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          client/dist/CiberMondayClient.exe
          client/dist/CiberMondayService.exe
          client/dist/CiberMondayWatchdog.exe
          client/install_exe_service.bat
        tag_name: v${{ github.event.inputs.version }}
        name: CiberMonday Client v${{ github.event.inputs.version }}
        prerelease: ${{ github.event.inputs.prerelease }}
        body: |
          # CiberMonday Client v${{ github.event.inputs.version }}
          
          Ejecutables compilados del cliente CiberMonday para Windows.
          
          ##  Archivos incluidos
          
          - **CiberMondayClient.exe** - Cliente principal
          - **CiberMondayService.exe** - Servicio de Windows
          - **CiberMondayWatchdog.exe** - Watchdog independiente
          - **install_exe_service.bat** - Instalador del servicio
          
          ##  Instrucciones de instalaci贸n
          
          1. Descarga **todos los archivos** del release
          2. Extrae los archivos en una carpeta (ej: `C:\CiberMonday\`)
          3. **Opci贸n A - Ejecuci贸n directa:**
             - Ejecuta `CiberMondayClient.exe` como Administrador
             - **Se abrir谩 una ventana de configuraci贸n** la primera vez
             - Ingresa la URL del servidor (ej: `http://192.168.1.100:5000`)
             - La configuraci贸n se guardar谩 autom谩ticamente en el registro de Windows
          
          4. **Opci贸n B - Como servicio (Recomendado):**
             - Ejecuta `install_exe_service.bat` como Administrador
             - Si es la primera vez, se abrir谩 la ventana de configuraci贸n
             - El servicio se iniciar谩 autom谩ticamente despu茅s de configurar
          
          **Estructura de archivos despu茅s de extraer:**
          ```
          C:\CiberMonday\
           CiberMondayClient.exe
           CiberMondayService.exe
           CiberMondayWatchdog.exe
           install_exe_service.bat
          ```
          
          **Nota**: Ya no necesitas `config.py`. La configuraci贸n se guarda en el registro de Windows y se muestra una ventana GUI la primera vez que ejecutas el cliente.
          
          ##  Requisitos
          
          - Windows 10 o superior
          - Permisos de Administrador
          - Conexi贸n de red al servidor
          
          ##  Gesti贸n del servicio
          
          ```bash
          CiberMondayService.exe start    # Iniciar
          CiberMondayService.exe stop     # Detener
          CiberMondayService.exe restart  # Reiniciar
          CiberMondayService.exe remove   # Desinstalar
          ```
          
          O desde `services.msc` buscando "CiberMonday Client Service"
          
          ##  Notas
          
          - El cliente funciona sin conexi贸n continua gracias al registro local de Windows
          - Sincroniza con el servidor cada 30 segundos
          - Bloquea autom谩ticamente la PC cuando expira el tiempo asignado
          
          ---
          
          **Compilado el:** ${{ github.event.head_commit.timestamp || github.run_started_at }}  
          **Commit:** ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
