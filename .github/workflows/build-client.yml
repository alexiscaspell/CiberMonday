name: Build Windows Client

on:
  workflow_dispatch:  # Solo ejecuci√≥n manual
    inputs:
      version:
        description: 'Versi√≥n del release (ej: 1.0.0)'
        required: true
        default: '1.0.0'
      prerelease:
        description: '¬øEs una versi√≥n pre-release?'
        required: false
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Necesario para crear releases
      pull-requests: read  # Solo lectura para PRs
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install Flask flask-cors requests pywin32 pyinstaller
    
    - name: Compilar cliente
      working-directory: ./client
      run: |
        pyinstaller --onefile `
          --name "CiberMondayClient" `
          --hidden-import "winreg" `
          --hidden-import "win32serviceutil" `
          --hidden-import "win32service" `
          --hidden-import "win32event" `
          --hidden-import "servicemanager" `
          --hidden-import "win32timezone" `
          --hidden-import "protection" `
          --hidden-import "registry_manager" `
          --hidden-import "config_gui" `
          --hidden-import "tkinter" `
          --hidden-import "tkinter.ttk" `
          --hidden-import "tkinter.messagebox" `
          --hidden-import "requests" `
          --hidden-import "ctypes" `
          --hidden-import "ctypes.wintypes" `
          client.py
    
    - name: Compilar servicio
      working-directory: ./client
      run: |
        pyinstaller --onefile `
          --name "CiberMondayService" `
          --hidden-import "winreg" `
          --hidden-import "win32serviceutil" `
          --hidden-import "win32service" `
          --hidden-import "win32event" `
          --hidden-import "servicemanager" `
          --hidden-import "win32timezone" `
          --hidden-import "protection" `
          --hidden-import "firewall_manager" `
          --hidden-import "ctypes" `
          --hidden-import "ctypes.wintypes" `
          service.py
    
    - name: Compilar watchdog
      working-directory: ./client
      run: |
        pyinstaller --onefile `
          --name "CiberMondayWatchdog" `
          --hidden-import "winreg" `
          --hidden-import "subprocess" `
          --hidden-import "protection" `
          --hidden-import "ctypes" `
          --hidden-import "ctypes.wintypes" `
          watchdog.py
    
    - name: Verificar ejecutables generados
      working-directory: ./client/dist
      shell: cmd
      run: |
        dir *.exe
        if not exist CiberMondayClient.exe exit /b 1
        if not exist CiberMondayService.exe exit /b 1
        if not exist CiberMondayWatchdog.exe exit /b 1
    
    - name: Crear release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          client/dist/CiberMondayClient.exe
          client/dist/CiberMondayService.exe
          client/dist/CiberMondayWatchdog.exe
          client/install_exe_service.bat
          client/uninstall_exe_service.bat
        tag_name: v${{ github.event.inputs.version }}
        name: CiberMonday Client v${{ github.event.inputs.version }}
        prerelease: ${{ github.event.inputs.prerelease }}
        body: |
          # CiberMonday Client v${{ github.event.inputs.version }}
          
          Ejecutables compilados del cliente CiberMonday para Windows.
          
          ## üì¶ Archivos incluidos
          
          - **CiberMondayClient.exe** - Cliente principal
          - **CiberMondayService.exe** - Servicio de Windows
          - **CiberMondayWatchdog.exe** - Watchdog independiente
          - **install_exe_service.bat** - Instalador del servicio
          - **uninstall_exe_service.bat** - Desinstalador del servicio
          
          ## üöÄ Instrucciones de instalaci√≥n
          
          1. Descarga **todos los archivos** del release
          2. Extrae los archivos en una carpeta (ej: `C:\CiberMonday\`)
          3. Ejecuta `install_exe_service.bat` como Administrador
          4. Si es la primera vez, se abrir√° la ventana de configuraci√≥n del servidor
          5. El servicio se instalar√°, configurar√° e iniciar√° autom√°ticamente
          
          **Estructura de archivos despu√©s de extraer:**
          ```
          C:\CiberMonday\
          ‚îú‚îÄ‚îÄ CiberMondayClient.exe
          ‚îú‚îÄ‚îÄ CiberMondayService.exe
          ‚îú‚îÄ‚îÄ CiberMondayWatchdog.exe
          ‚îú‚îÄ‚îÄ install_exe_service.bat
          ‚îî‚îÄ‚îÄ uninstall_exe_service.bat
          ```
          
          **Nota**: La configuraci√≥n se guarda en el registro de Windows y se muestra una ventana GUI la primera vez.
          
          ## üõ°Ô∏è Protecciones del servicio
          
          El instalador configura m√∫ltiples capas de protecci√≥n:
          - **Inicio autom√°tico**: Se inicia con Windows en cada arranque
          - **Recuperaci√≥n autom√°tica**: Si el servicio falla, Windows lo reinicia en 5 segundos
          - **Watchdog interno**: Si el proceso del cliente muere, el servicio lo reinicia en 3 segundos
          - **Protecci√≥n DACL**: El proceso no puede ser terminado desde Task Manager por usuarios normales
          - **Permisos restringidos**: Solo administradores pueden detener el servicio
          
          ## üìã Requisitos
          
          - Windows 10 o superior
          - Permisos de Administrador
          - Conexi√≥n de red al servidor
          
          ## üîß Gesti√≥n del servicio (requiere Administrador)
          
          ```bash
          net start CiberMondayClient    # Iniciar
          net stop CiberMondayClient     # Detener
          ```
          
          ## üóëÔ∏è Desinstalaci√≥n
          
          Ejecuta `uninstall_exe_service.bat` como Administrador. Esto:
          - Detiene el servicio y mata procesos residuales
          - Elimina el servicio de Windows
          - Limpia las reglas del firewall
          - Rehabilita el Task Manager si fue deshabilitado
          
          ## üìù Notas
          
          - El cliente funciona sin conexi√≥n continua gracias al registro local de Windows
          - Sincroniza con el servidor cada 30 segundos
          - Bloquea autom√°ticamente la PC cuando expira el tiempo asignado
          
          ---
          
          **Compilado el:** ${{ github.event.head_commit.timestamp || github.run_started_at }}  
          **Commit:** ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
